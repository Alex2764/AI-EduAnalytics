# SUPABASE CLIENT INTEGRATION RULES

================================================================================
SECTION 1: SUPABASE CLIENT SETUP
================================================================================

## CLIENT INITIALIZATION

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/database.types';

// ✅ Environment variables validation
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables');
}

// ✅ Create typed Supabase client
export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});

// ✅ Export types for easier usage
export type Tables<T extends keyof Database['public']['Tables']> = 
  Database['public']['Tables'][T]['Row'];

export type Enums<T extends keyof Database['public']['Enums']> = 
  Database['public']['Enums'][T];

// Example usage:
// type User = Tables<'users'>;
// type UserRole = Enums<'user_role'>;
```

## TYPESCRIPT TYPES FROM SUPABASE

```bash
# Generate types from your Supabase database
npx supabase gen types typescript --project-id "your-project-id" > src/types/database.types.ts
```

```typescript
// src/types/database.types.ts (generated by Supabase CLI)
export type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]

export interface Database {
  public: {
    Tables: {
      users: {
        Row: {
          id: string
          email: string
          first_name: string | null
          last_name: string | null
          role: 'admin' | 'user' | 'guest'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          email: string
          first_name?: string | null
          last_name?: string | null
          role?: 'admin' | 'user' | 'guest'
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          email?: string
          first_name?: string | null
          last_name?: string | null
          role?: 'admin' | 'user' | 'guest'
          created_at?: string
          updated_at?: string
        }
      }
      test_results: {
        Row: {
          id: string
          user_id: string
          test_name: string
          score: number
          answers: Json
          created_at: string
        }
        Insert: {
          id?: string
          user_id: string
          test_name: string
          score: number
          answers: Json
          created_at?: string
        }
        Update: {
          id?: string
          user_id?: string
          test_name?: string
          score?: number
          answers?: Json
          created_at?: string
        }
      }
      // ... other tables
    }
    Enums: {
      user_role: 'admin' | 'user' | 'guest'
    }
  }
}
```

## MANUAL TYPE DEFINITIONS (ако няма CLI)

```typescript
// src/types/supabase.types.ts

export interface User {
  id: string;
  email: string;
  first_name: string | null;
  last_name: string | null;
  role: 'admin' | 'user' | 'guest';
  created_at: string;
  updated_at: string;
}

export interface TestResult {
  id: string;
  user_id: string;
  test_name: string;
  score: number;
  answers: Record<string, any>; // JSON type
  created_at: string;
}

export interface AnalysisRequest {
  id: string;
  user_id: string;
  test_result_id: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  ai_response: string | null;
  created_at: string;
  updated_at: string;
}
```

================================================================================
SECTION 2: DATABASE QUERIES
================================================================================

## SELECT QUERIES

```typescript
// ✅ Basic select - get all users
const { data: users, error } = await supabase
  .from('users')
  .select('*');

// ✅ Select specific columns
const { data: users, error } = await supabase
  .from('users')
  .select('id, email, first_name, last_name');

// ✅ Filter with where conditions
const { data: admins, error } = await supabase
  .from('users')
  .select('*')
  .eq('role', 'admin'); // WHERE role = 'admin'

// ✅ Multiple filters
const { data: results, error } = await supabase
  .from('test_results')
  .select('*')
  .eq('user_id', userId)
  .gte('score', 50) // score >= 50
  .order('created_at', { ascending: false });

// ✅ Join tables (foreign key relationships)
const { data: results, error } = await supabase
  .from('test_results')
  .select(`
    *,
    user:users (
      id,
      email,
      first_name,
      last_name
    )
  `)
  .eq('user_id', userId);

// ✅ Count rows
const { count, error } = await supabase
  .from('users')
  .select('*', { count: 'exact', head: true });

// ✅ Single row
const { data: user, error } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)
  .single(); // Returns single object, not array

// ✅ Pagination
const pageSize = 10;
const page = 1;

const { data: users, error } = await supabase
  .from('users')
  .select('*')
  .range(page * pageSize, (page + 1) * pageSize - 1);
```

## INSERT QUERIES

```typescript
// ✅ Insert single row
const { data: newUser, error } = await supabase
  .from('users')
  .insert({
    email: 'user@example.com',
    first_name: 'John',
    last_name: 'Doe',
    role: 'user',
  })
  .select()
  .single();

// ✅ Insert multiple rows
const { data: newUsers, error } = await supabase
  .from('users')
  .insert([
    { email: 'user1@example.com', first_name: 'John' },
    { email: 'user2@example.com', first_name: 'Jane' },
  ])
  .select();

// ✅ Insert with typed data
import type { Tables } from '@/lib/supabase';

type UserInsert = Tables<'users'>['Insert'];

const newUserData: UserInsert = {
  email: 'user@example.com',
  first_name: 'John',
  last_name: 'Doe',
};

const { data, error } = await supabase
  .from('users')
  .insert(newUserData)
  .select()
  .single();
```

## UPDATE QUERIES

```typescript
// ✅ Update single row by ID
const { data: updatedUser, error } = await supabase
  .from('users')
  .update({
    first_name: 'Jane',
    updated_at: new Date().toISOString(),
  })
  .eq('id', userId)
  .select()
  .single();

// ✅ Update multiple rows
const { data, error } = await supabase
  .from('test_results')
  .update({ score: 100 })
  .eq('user_id', userId)
  .gte('score', 90);

// ✅ Upsert (insert or update)
const { data, error } = await supabase
  .from('users')
  .upsert({
    id: userId, // If exists, update; otherwise insert
    email: 'user@example.com',
    first_name: 'John',
  })
  .select();
```

## DELETE QUERIES

```typescript
// ✅ Delete single row
const { error } = await supabase
  .from('users')
  .delete()
  .eq('id', userId);

// ✅ Delete multiple rows
const { error } = await supabase
  .from('test_results')
  .delete()
  .eq('user_id', userId)
  .lt('created_at', '2024-01-01');

// ✅ Delete with return data
const { data: deletedUser, error } = await supabase
  .from('users')
  .delete()
  .eq('id', userId)
  .select()
  .single();
```

## ERROR HANDLING

```typescript
// ✅ Always check for errors
const { data, error } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)
  .single();

if (error) {
  console.error('Supabase error:', error);
  throw new Error(`Failed to fetch user: ${error.message}`);
}

// ✅ Type-safe error handling
import { PostgrestError } from '@supabase/supabase-js';

async function fetchUser(userId: string) {
  const { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('id', userId)
    .single();
  
  if (error) {
    // PostgrestError has: message, details, hint, code
    if (error.code === 'PGRST116') {
      // No rows returned
      return null;
    }
    throw error;
  }
  
  return data;
}

// ✅ Try-catch pattern for async functions
async function createUser(email: string) {
  try {
    const { data, error } = await supabase
      .from('users')
      .insert({ email })
      .select()
      .single();
    
    if (error) throw error;
    
    return data;
  } catch (error) {
    console.error('Failed to create user:', error);
    return null;
  }
}
```

================================================================================
SECTION 3: AUTHENTICATION
================================================================================

## AUTH SETUP

```typescript
// src/lib/auth.ts
import { supabase } from './supabase';
import type { User, Session } from '@supabase/supabase-js';

// ✅ Sign up
export async function signUp(email: string, password: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: `${window.location.origin}/auth/callback`,
    },
  });
  
  if (error) throw error;
  return data;
}

// ✅ Sign in with email/password
export async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });
  
  if (error) throw error;
  return data;
}

// ✅ Sign out
export async function signOut() {
  const { error } = await supabase.auth.signOut();
  if (error) throw error;
}

// ✅ Get current session
export async function getSession() {
  const { data, error } = await supabase.auth.getSession();
  if (error) throw error;
  return data.session;
}

// ✅ Get current user
export async function getCurrentUser() {
  const { data, error } = await supabase.auth.getUser();
  if (error) throw error;
  return data.user;
}

// ✅ Reset password
export async function resetPassword(email: string) {
  const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${window.location.origin}/auth/reset-password`,
  });
  
  if (error) throw error;
  return data;
}

// ✅ Update password
export async function updatePassword(newPassword: string) {
  const { data, error } = await supabase.auth.updateUser({
    password: newPassword,
  });
  
  if (error) throw error;
  return data;
}
```

## useAuth HOOK

```typescript
// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import type { User, Session } from '@supabase/supabase-js';

interface UseAuthReturn {
  user: User | null;
  session: Session | null;
  isLoading: boolean;
  signIn: (email: string, password: string) => Promise<void>;
  signUp: (email: string, password: string) => Promise<void>;
  signOut: () => Promise<void>;
}

export function useAuth(): UseAuthReturn {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setIsLoading(false);
    });
    
    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session);
        setUser(session?.user ?? null);
        setIsLoading(false);
      }
    );
    
    return () => subscription.unsubscribe();
  }, []);
  
  const signIn = async (email: string, password: string) => {
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    if (error) throw error;
  };
  
  const signUp = async (email: string, password: string) => {
    const { error } = await supabase.auth.signUp({
      email,
      password,
    });
    if (error) throw error;
  };
  
  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  };
  
  return { user, session, isLoading, signIn, signUp, signOut };
}

// ✅ Usage in component
function LoginPage() {
  const { signIn, isLoading } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await signIn(email, password);
      // Redirect to dashboard
    } catch (error) {
      console.error('Login failed:', error);
    }
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
      />
      <input
        type="password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
      />
      <button type="submit" disabled={isLoading}>
        Login
      </button>
    </form>
  );
}
```

## PROTECTED ROUTES

```typescript
// src/components/ProtectedRoute.tsx
import { Navigate } from 'react-router-dom';
import { useAuth } from '@/hooks/useAuth';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

export function ProtectedRoute({ children }: ProtectedRouteProps) {
  const { user, isLoading } = useAuth();
  
  if (isLoading) {
    return <div>Loading...</div>;
  }
  
  if (!user) {
    return <Navigate to="/login" replace />;
  }
  
  return <>{children}</>;
}

// Usage in App.tsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/login" element={<LoginPage />} />
        <Route
          path="/dashboard"
          element={
            <ProtectedRoute>
              <Dashboard />
            </ProtectedRoute>
          }
        />
      </Routes>
    </BrowserRouter>
  );
}
```

================================================================================
SECTION 4: REAL-TIME SUBSCRIPTIONS
================================================================================

## REAL-TIME QUERIES

```typescript
// ✅ Subscribe to INSERT events
useEffect(() => {
  const channel = supabase
    .channel('test_results_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'test_results',
        filter: `user_id=eq.${userId}`,
      },
      (payload) => {
        console.log('New test result:', payload.new);
        // Update local state
        setTestResults(prev => [...prev, payload.new]);
      }
    )
    .subscribe();
  
  return () => {
    supabase.removeChannel(channel);
  };
}, [userId]);

// ✅ Subscribe to all changes (INSERT, UPDATE, DELETE)
useEffect(() => {
  const channel = supabase
    .channel('users_changes')
    .on(
      'postgres_changes',
      {
        event: '*', // All events
        schema: 'public',
        table: 'users',
      },
      (payload) => {
        console.log('Change received:', payload);
        
        switch (payload.eventType) {
          case 'INSERT':
            console.log('New user:', payload.new);
            break;
          case 'UPDATE':
            console.log('Updated user:', payload.new);
            break;
          case 'DELETE':
            console.log('Deleted user:', payload.old);
            break;
        }
      }
    )
    .subscribe();
  
  return () => {
    supabase.removeChannel(channel);
  };
}, []);
```

## useRealtime CUSTOM HOOK

```typescript
// src/hooks/useRealtime.ts
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';
import type { RealtimeChannel } from '@supabase/supabase-js';

interface UseRealtimeOptions<T> {
  table: string;
  filter?: string;
  event?: 'INSERT' | 'UPDATE' | 'DELETE' | '*';
  onInsert?: (record: T) => void;
  onUpdate?: (record: T) => void;
  onDelete?: (record: T) => void;
}

export function useRealtime<T>({
  table,
  filter,
  event = '*',
  onInsert,
  onUpdate,
  onDelete,
}: UseRealtimeOptions<T>) {
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    const channel = supabase
      .channel(`${table}_changes`)
      .on(
        'postgres_changes',
        {
          event,
          schema: 'public',
          table,
          filter,
        },
        (payload) => {
          setIsConnected(true);
          
          switch (payload.eventType) {
            case 'INSERT':
              onInsert?.(payload.new as T);
              break;
            case 'UPDATE':
              onUpdate?.(payload.new as T);
              break;
            case 'DELETE':
              onDelete?.(payload.old as T);
              break;
          }
        }
      )
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          setIsConnected(true);
        }
      });
    
    return () => {
      supabase.removeChannel(channel);
      setIsConnected(false);
    };
  }, [table, filter, event, onInsert, onUpdate, onDelete]);
  
  return { isConnected };
}

// ✅ Usage
function TestResultsList({ userId }: { userId: string }) {
  const [results, setResults] = useState<TestResult[]>([]);
  
  useRealtime<TestResult>({
    table: 'test_results',
    filter: `user_id=eq.${userId}`,
    event: 'INSERT',
    onInsert: (newResult) => {
      setResults(prev => [newResult, ...prev]);
      console.log('New test result received!');
    },
  });
  
  return (
    <div>
      {results.map(result => (
        <div key={result.id}>{result.test_name}</div>
      ))}
    </div>
  );
}
```

================================================================================
SECTION 5: CUSTOM HOOKS FOR COMMON OPERATIONS
================================================================================

## useSupabaseQuery HOOK

```typescript
// src/hooks/useSupabaseQuery.ts
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import type { PostgrestError } from '@supabase/supabase-js';

interface UseSupabaseQueryOptions<T> {
  table: string;
  select?: string;
  filter?: (query: any) => any;
  dependencies?: any[];
}

interface UseSupabaseQueryReturn<T> {
  data: T | null;
  isLoading: boolean;
  error: PostgrestError | null;
  refetch: () => Promise<void>;
}

export function useSupabaseQuery<T>({
  table,
  select = '*',
  filter,
  dependencies = [],
}: UseSupabaseQueryOptions<T>): UseSupabaseQueryReturn<T> {
  const [data, setData] = useState<T | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<PostgrestError | null>(null);
  
  const fetchData = async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      let query = supabase.from(table).select(select);
      
      if (filter) {
        query = filter(query);
      }
      
      const { data, error } = await query;
      
      if (error) throw error;
      
      setData(data as T);
    } catch (err) {
      setError(err as PostgrestError);
    } finally {
      setIsLoading(false);
    }
  };
  
  useEffect(() => {
    fetchData();
  }, dependencies);
  
  return { data, isLoading, error, refetch: fetchData };
}

// ✅ Usage
function UsersList() {
  const { data: users, isLoading, error } = useSupabaseQuery<User[]>({
    table: 'users',
    select: 'id, email, first_name, last_name',
    filter: (query) => query.eq('role', 'admin').order('created_at', { ascending: false }),
  });
  
  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  
  return (
    <div>
      {users?.map(user => (
        <div key={user.id}>{user.email}</div>
      ))}
    </div>
  );
}
```

## useSupabaseMutation HOOK

```typescript
// src/hooks/useSupabaseMutation.ts
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import type { PostgrestError } from '@supabase/supabase-js';

interface UseSupabaseMutationReturn<T> {
  mutate: (data: T) => Promise<void>;
  isLoading: boolean;
  error: PostgrestError | null;
  data: any;
}

export function useSupabaseMutation<T>(
  table: string,
  operation: 'insert' | 'update' | 'delete'
): UseSupabaseMutationReturn<T> {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<PostgrestError | null>(null);
  const [data, setData] = useState<any>(null);
  
  const mutate = async (payload: T) => {
    try {
      setIsLoading(true);
      setError(null);
      
      let result;
      
      switch (operation) {
        case 'insert':
          result = await supabase.from(table).insert(payload).select();
          break;
        case 'update':
          result = await supabase.from(table).update(payload).select();
          break;
        case 'delete':
          result = await supabase.from(table).delete();
          break;
      }
      
      if (result.error) throw result.error;
      
      setData(result.data);
    } catch (err) {
      setError(err as PostgrestError);
    } finally {
      setIsLoading(false);
    }
  };
  
  return { mutate, isLoading, error, data };
}

// ✅ Usage
function CreateUserForm() {
  const { mutate: createUser, isLoading, error } = useSupabaseMutation<UserInsert>(
    'users',
    'insert'
  );
  
  const handleSubmit = async (formData: UserInsert) => {
    await createUser(formData);
    console.log('User created!');
  };
  
  return (
    <form onSubmit={(e) => {
      e.preventDefault();
      handleSubmit({ email: 'test@example.com' });
    }}>
      <button type="submit" disabled={isLoading}>
        {isLoading ? 'Creating...' : 'Create User'}
      </button>
      {error && <p>Error: {error.message}</p>}
    </form>
  );
}
```

================================================================================
QUICK CHECKLIST
================================================================================

Before using Supabase in production:
- [ ] Environment variables set (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
- [ ] TypeScript types generated or defined
- [ ] Row Level Security (RLS) enabled on all tables
- [ ] Error handling implemented for all queries
- [ ] Auth state listener set up (onAuthStateChange)
- [ ] Real-time subscriptions cleaned up on unmount
- [ ] Pagination implemented for large datasets
- [ ] Proper indexes created in database
- [ ] Auth redirects configured
- [ ] Session persistence enabled

================================================================================
COMMON MISTAKES TO AVOID
================================================================================

❌ Not checking for errors
✅ Always check: if (error) throw error;

❌ Forgetting .single() for single row
✅ Use .single() when expecting one row

❌ Not cleaning up real-time subscriptions
✅ Always: return () => supabase.removeChannel(channel);

❌ Missing Row Level Security (RLS)
✅ Enable RLS on all tables in Supabase dashboard

❌ Hardcoding Supabase credentials
✅ Use environment variables: import.meta.env.VITE_SUPABASE_URL

❌ Not handling auth state changes
✅ Use supabase.auth.onAuthStateChange()

❌ Fetching all data without pagination
✅ Use .range() for pagination

❌ Not typing Supabase queries
✅ Use Database types: createClient<Database>(...)

================================================================================
END OF SUPABASE CLIENT INTEGRATION RULES
================================================================================